<!doctype html>
<html lang="vi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>DucHai.com â€” Dark Luxury (Single File)</title>
<style>
:root{
  --bg:#070708; --panel:#0f1112; --muted:#9a988f; --gold:#FFD700; --glass: rgba(255,255,255,0.02);
}
*{box-sizing:border-box}
body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial;background:linear-gradient(180deg,#050506,#0b0b0c);color:#eee}
.header{position:fixed;left:0;right:0;top:0;height:64px;background:linear-gradient(90deg,#000,#141414);display:flex;align-items:center;padding:10px 16px;z-index:200;border-bottom:1px solid rgba(255,215,0,0.04)}
.brand{display:flex;gap:12px;align-items:center}
.logo{width:44px;height:44;border-radius:8px;background:linear-gradient(135deg,#222,#111);display:flex;align-items:center;justify-content:center;color:var(--gold);font-weight:800}
.title{font-weight:700;color:var(--gold);font-size:1rem}
.subtitle{font-size:0.78rem;color:var(--muted);margin-top:2px}
.controls{margin-left:auto;display:flex;gap:10px;align-items:center}
.btn{background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--gold);padding:8px 10px;border-radius:8px;cursor:pointer}
.hamburger{background:transparent;border:0;color:var(--gold);font-size:20px;padding:8px;cursor:pointer}
.sidebar{position:fixed;left:-320px;top:0;width:320px;height:100vh;background:linear-gradient(180deg,#0b0b0c,#0f0f10);padding:18px;box-shadow:16px 0 60px rgba(0,0,0,0.6);transition:left .22s ease;z-index:210}
.sidebar.open{left:0}
.sidebar .close{color:var(--muted);text-align:right;cursor:pointer;margin-bottom:10px}
.sidebar a{display:block;padding:10px 12px;color:var(--gold);text-decoration:none;border-radius:8px;margin:6px 0}
.sidebar a:hover{background:rgba(255,215,0,0.03);color:#fff}
.container{max-width:1100px;margin:92px auto;padding:18px}
.card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.00));border-radius:12px;padding:16px;margin-bottom:14px;border:1px solid rgba(255,215,0,0.04)}
.grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:12px}
.small{font-size:0.9rem;color:var(--muted)}
.input,textarea,select{width:100%;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.03);background:transparent;color:inherit}
.primary{background:linear-gradient(90deg,var(--gold),#ffd24d);border:0;padding:10px 12px;border-radius:8px;color:#000;font-weight:700;cursor:pointer}
.ghost{background:transparent;border:1px solid rgba(255,255,255,0.04);padding:8px;border-radius:8px;color:var(--muted);cursor:pointer}
.item{background:rgba(255,255,255,0.01);padding:12px;border-radius:8px;border:1px solid rgba(255,255,255,0.02)}
.title{font-weight:700;color:var(--gold)}
.muted{color:var(--muted)}
.page{display:none}
.page.active{display:block;animation:fadeIn .22s ease}
@keyframes fadeIn{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:none}}
.footer{margin-top:18px;color:var(--muted);font-size:0.9rem;text-align:center}
@media(max-width:760px){.container{margin:120px 12px}}
.light-mode{background:#f7f7f7;color:#111}
.light-mode .logo{background:linear-gradient(135deg,#fff,#eee);color:#111}
</style>
</head>
<body>

<header class="header">
  <div class="brand">
    <div class="logo">DH</div>
    <div>
      <div class="title">DucHai.com</div>
      <div class="subtitle">Dark Luxury â€¢ Game Utilities</div>
    </div>
  </div>

  <div class="controls">
    <div id="sessionDisplay" class="small muted">ChÆ°a Ä‘Äƒng nháº­p</div>
    <button id="themeBtn" class="btn" title="Chuyá»ƒn cháº¿ Ä‘á»™">ğŸŒ‘</button>
    <button id="hamburger" class="hamburger" title="Menu">â˜°</button>
  </div>
</header>

<nav id="sidebar" class="sidebar" aria-hidden="true">
  <div class="close" id="closeSidebar">âœ–</div>
  <a href="#" data-page="home">Giá»›i thiá»‡u</a>
  <a href="#" id="menuStart" data-page="start">Báº¯t Ä‘áº§u</a>
  <a href="#" id="menuLogin" data-page="login">ÄÄƒng nháº­p</a>
  <a href="#" id="menuRegister" data-page="register">ÄÄƒng kÃ½</a>
  <a href="#" data-page="products">Sáº£n pháº©m</a>
  <a href="#" data-page="blinds">TÃºi mÃ¹</a>
  <a href="#" data-page="deposit">Náº¡p tiá»n</a>
  <a href="#" id="menuAdmin" data-page="admin" style="display:none">Trang quáº£n trá»‹</a>
  <a href="#" id="menuLogout" style="display:none">ÄÄƒng xuáº¥t</a>
  <div class="muted">PhiÃªn: <span id="sidebarUser">KhÃ¡ch</span></div>
</nav>

<main class="container">
  <!-- Home -->
  <section id="home" class="page card active">
    <h1>ChÃ o má»«ng Ä‘áº¿n DucHai.com</h1>
    <p class="small muted">Zalo Admin : 0899119398 </p>
    <div style="margin-top:12px">
      <button class="primary" data-page="start">Báº¯t Ä‘áº§u â†’</button>
    </div>
  </section>

  <!-- Start -->
  <section id="start" class="page card">
    <h2>Báº¯t Ä‘áº§u</h2>
    <p class="muted">ÄÄƒng nháº­p hoáº·c táº¡o tÃ i khoáº£n Ä‘á»ƒ sá»­ dá»¥ng</p>
    <div style="margin-top:12px;display:flex;gap:10px">
      <button class="primary" data-page="login">ÄÄƒng nháº­p</button>
      <button class="ghost" data-page="register">ÄÄƒng kÃ½</button>
    </div>
  </section>

  <!-- Login -->
  <section id="login" class="page card">
    <h2>ÄÄƒng nháº­p</h2>
    <div style="max-width:520px">
      <input id="loginUser" class="input" placeholder="TÃªn Ä‘Äƒng nháº­p (username)">
      <input id="loginPass" class="input" type="password" placeholder="Máº­t kháº©u">
      <div style="display:flex;gap:10px;margin-top:10px">
        <button class="primary" id="btnLogin">ÄÄƒng nháº­p</button>
        <button class="ghost" data-page="register">ChÆ°a cÃ³ tÃ i khoáº£n?</button>
      </div>
      <p id="loginMsg" class="muted" style="margin-top:8px"></p>
    </div>
  </section>

  <!-- Register -->
  <section id="register" class="page card">
    <h2>ÄÄƒng kÃ½</h2>
    <div style="max-width:520px">
      <input id="regUser" class="input" placeholder="TÃªn Ä‘Äƒng nháº­p (username)">
      <input id="regPass" class="input" type="password" placeholder="Máº­t kháº©u">
      <div style="display:flex;gap:8px;align-items:center;margin-top:8px">
        <div id="captchaBox" class="item small" style="background:rgba(255,215,0,0.04);color:var(--gold)"></div>
        <input id="captchaInput" class="input" placeholder="Nháº­p captcha" style="flex:1">
      </div>
      <div style="display:flex;gap:10px;margin-top:12px">
        <button class="primary" id="btnRegister">XÃ¡c nháº­n</button>
        <button class="ghost" id="btnReloadCaptcha">Láº¥y mÃ£ má»›i</button>
      </div>
      <p id="regMsg" class="muted" style="margin-top:8px"></p>
    </div>
  </section>

  <!-- Products -->
  <section id="products" class="page card">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <div>
        <h2>Sáº£n pháº©m</h2>
        <p class="small muted">Mua sáº£n pháº©m â€” trá»« tiá»n trong tÃ i khoáº£n vÃ  má»Ÿ link (link khÃ´ng hiá»ƒn thá»‹ trÆ°á»›c khi mua).</p>
      </div>
      <div class="small muted">Sá»‘ dÆ°: <strong id="uiBalance">0 VNÄ</strong></div>
    </div>
    <div id="productList" class="grid" style="margin-top:12px"></div>
  </section>

  <!-- Blinds -->
  <section id="blinds" class="page card">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <div><h2>TÃºi mÃ¹ LiÃªn QuÃ¢n</h2><p class="small muted">Mua tÃºi mÃ¹ Ä‘á»ƒ nháº­n TK/MK hoáº·c pháº§n thÆ°á»Ÿng (thÃ´ng tin khÃ´ng hiá»ƒn thá»‹ trÆ°á»›c khi mua).</p></div>
      <div class="small muted">Sá»‘ dÆ°: <strong id="uiBalance2">0 VNÄ</strong></div>
    </div>
    <div id="blindList" class="grid" style="margin-top:12px"></div>
  </section>

  <!-- Deposit -->
  <section id="deposit" class="page card">
    <h2>Náº¡p tiá»n</h2>
    <div style="display:flex;gap:12px;flex-wrap:wrap">
      <div style="min-width:260px">
        <div class="card" style="background:rgba(255,215,0,0.03);border:1px solid rgba(255,215,0,0.06)">
          <p><strong>NgÃ¢n hÃ ng</strong>: MBBANK</p>
          <p><strong>Sá»‘ TK</strong>: 381112</p>
          <p><strong>Chá»§ TK</strong>: DAO DUC HAI</p>
          <p><strong>Ná»™i dung</strong>: <span id="depositMemo">dh_username</span></p>
          <img id="depositQR" src="" alt="VietQR" style="width:100%;border-radius:8px;margin-top:8px">
        </div>
      </div>

      <div style="flex:1;min-width:260px">
        <label class="small muted">Nháº­p sá»‘ tiá»n muá»‘n náº¡p (VNÄ)</label>
        <input id="depositAmount" class="input" type="number" placeholder="VÃ­ dá»¥: 10000">
        <div style="display:flex;gap:8px;margin-top:8px">
          <button class="primary" id="btnPaid">TÃ´i Ä‘Ã£ náº¡p</button>
          <button class="ghost" id="btnCopyMemo">Sao chÃ©p ná»™i dung</button>
        </div>
        <p id="depositStatus" class="muted small" style="margin-top:8px"></p>

        <div style="margin-top:12px">
          <h3 class="small muted">Lá»‹ch sá»­ yÃªu cáº§u náº¡p</h3>
          <div id="topupHistory" class="small muted" style="margin-top:8px"></div>
        </div>
      </div>
    </div>
  </section>

  <!-- Admin -->
  <section id="admin" class="page card">
    <h2>Trang quáº£n trá»‹</h2>

    <div style="margin-top:12px">
      <h3>Quáº£n lÃ½ sáº£n pháº©m</h3>
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <input id="admin_p_name" class="input" placeholder="TÃªn sáº£n pháº©m" style="flex:2">
        <input id="admin_p_price" class="input" placeholder="GiÃ¡ (VNÄ)" style="flex:1">
        <input id="admin_p_link" class="input" placeholder="Link (URL)" style="flex:2">
      </div>
      <div style="display:flex;gap:8px;margin-top:8px">
        <button class="primary" id="adminAddProd">ThÃªm / LÆ°u</button>
        <button class="ghost" id="adminClearProd">XÃ³a form</button>
      </div>
      <div id="adminProducts" style="margin-top:12px"></div>
    </div>

    <hr style="opacity:.06;margin:18px 0">

    <div>
      <h3>Quáº£n lÃ½ TÃºi mÃ¹</h3>
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <input id="admin_b_name" class="input" placeholder="TÃªn" style="flex:2">
        <input id="admin_b_price" class="input" placeholder="GiÃ¡ (VNÄ)" style="flex:1">
        <input id="admin_b_acc" class="input" placeholder="TÃ i khoáº£n" style="flex:1">
        <input id="admin_b_pass" class="input" placeholder="Máº­t kháº©u" style="flex:1">
      </div>
      <div style="display:flex;gap:8px;margin-top:8px">
        <button class="primary" id="adminAddBlind">ThÃªm / LÆ°u</button>
        <button class="ghost" id="adminClearBlind">XÃ³a form</button>
      </div>
      <div id="adminBlinds" style="margin-top:12px"></div>
    </div>

    <hr style="opacity:.06;margin:18px 0">

    <div>
      <h3>YÃªu cáº§u náº¡p tiá»n (Pending)</h3>
      <div id="adminTopups" style="margin-top:8px"></div>
    </div>

    <hr style="opacity:.06;margin:18px 0">

    <div>
      <h3>Danh sÃ¡ch ngÆ°á»i dÃ¹ng</h3>
      <div id="adminUsers" style="margin-top:8px"></div>
    </div>
  </section>

  <div class="footer">Website By DucHai.com</div>
</main>

<script>
/* Single-file app
 Admin credentials: admin / haiidz1
 Data keys:
  - users: { username: { password, balance, purchases:[], regTime, regIp } }
  - products: [{name,price,link}]
  - blinds: [{name,price,acc,pass}]
  - topupRequests: [{id,user,amount,time,status}]
 Session: sessionStorage.sessionUser
*/

// constants
const ADMIN_USER = 'admin', ADMIN_PASS = 'haiidz1';

// helpers
const $ = id => document.getElementById(id);
const read = k => { try { return JSON.parse(localStorage.getItem(k)); } catch(e){ return null } }
const write = (k,v) => localStorage.setItem(k, JSON.stringify(v));
const uid = () => 'id'+Date.now().toString(36)+Math.random().toString(36).slice(2,6);
const money = v => Number(v||0).toLocaleString('vi-VN') + ' VNÄ';
const escapeHtml = s => (s||'').toString().replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;');

// seed data
if(!read('users')) write('users', {});
if(!read('products')) write('products', [
  {name:'Mod LiÃªn QuÃ¢n VIP', price:15000, link:'https://example.com/mod-vip'},
  {name:'Skin may máº¯n', price:8000, link:'https://example.com/skin-random'}
]);
if(!read('blinds')) write('blinds', [
  {name:'TÃºi mÃ¹ cÆ¡ báº£n', price:5000, acc:'acc_demo1', pass:'pass123'},
  {name:'TÃºi mÃ¹ pro', price:20000, acc:'acc_pro', pass:'pro123'}
]);
if(!read('topupRequests')) write('topupRequests', []);

// session
let currentUser = sessionStorage.getItem('sessionUser') || null;
function setSession(u){
  currentUser = u;
  if(u) sessionStorage.setItem('sessionUser', u);
  else sessionStorage.removeItem('sessionUser');
  updateAuthUI();
}

// sidebar controls
const sidebar = $('sidebar'), hamburger = $('hamburger'), closeSidebar = $('closeSidebar');
hamburger.addEventListener('click', ()=> sidebar.classList.add('open'));
closeSidebar.addEventListener('click', ()=> sidebar.classList.remove('open'));
document.querySelectorAll('[data-page]').forEach(a=>{
  a.addEventListener('click', e=>{
    e.preventDefault();
    const p = a.dataset.page;
    showPage(p);
    sidebar.classList.remove('open');
  });
});

// theme
$('themeBtn').addEventListener('click', ()=>{
  document.body.classList.toggle('light-mode');
  $('themeBtn').innerText = document.body.classList.contains('light-mode') ? 'â˜€ï¸' : 'ğŸŒ‘';
});

// nav show page
function showPage(id){
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  const node = $(id);
  if(node) node.classList.add('active');
  if(id === 'register') generateCaptcha();
  if(id === 'products') renderProducts();
  if(id === 'blinds') renderBlinds();
  if(id === 'deposit') updateDepositUI();
  if(id === 'admin'){ if(currentUser === ADMIN_USER) renderAdminAll(); else { alert('Báº¡n khÃ´ng cÃ³ quyá»n'); showPage('home'); } }
}

// auth UI updates
function updateAuthUI(){
  $('sidebarUser').innerText = currentUser || 'KhÃ¡ch';
  $('sessionDisplay').innerText = currentUser ? ('ÄÄƒng nháº­p: ' + currentUser) : 'ChÆ°a Ä‘Äƒng nháº­p';
  if(currentUser){
    $('menuLogin').style.display = 'none';
    $('menuRegister').style.display = 'none';
    $('menuStart').style.display = 'none';
    $('menuLogout').style.display = 'block';
    $('menuAdmin').style.display = (currentUser === ADMIN_USER) ? 'block' : 'none';
  } else {
    $('menuLogin').style.display = 'block';
    $('menuRegister').style.display = 'block';
    $('menuStart').style.display = 'block';
    $('menuLogout').style.display = 'none';
    $('menuAdmin').style.display = 'none';
  }
  refreshBalances();
  renderTopupHistory();
}

// captcha
let captchaVal='';
function generateCaptcha(){
  const a = Math.floor(Math.random()*9)+1, b = Math.floor(Math.random()*9)+1;
  captchaVal = (a+b).toString();
  $('captchaBox').innerText = `${a} + ${b} = ?`;
}
$('btnReloadCaptcha').addEventListener('click', generateCaptcha);

// get local IPs via WebRTC (best-effort)
async function getLocalIPs(timeout=1500){
  return new Promise((resolve)=>{
    const ips = new Set();
    const RTCPeerConnection = window.RTCPeerConnection || window.webkitRTCPeerConnection || window.mozRTCPeerConnection;
    if(!RTCPeerConnection){ resolve(['unknown']); return; }
    const pc = new RTCPeerConnection({iceServers:[]});
    pc.createDataChannel('');
    pc.onicecandidate = (evt) => {
      if(!evt || !evt.candidate){ pc.close(); resolve(ips.size ? Array.from(ips) : ['unknown']); return; }
      const s = evt.candidate.candidate;
      const m = s.match(/([0-9]{1,3}(\.[0-9]{1,3}){3})/);
      if(m) ips.add(m[1]);
    };
    pc.createOffer().then(o=> pc.setLocalDescription(o)).catch(()=> { pc.close(); resolve(['unknown']); });
    setTimeout(()=> { if(ips.size===0) resolve(['unknown']); }, timeout);
  });
}

// register
$('btnRegister').addEventListener('click', async ()=>{
  const u = $('regUser').value.trim();
  const p = $('regPass').value;
  const c = $('captchaInput').value.trim();
  if(!u || !p){ $('regMsg').innerText = 'Nháº­p Ä‘á»§ thÃ´ng tin'; return; }
  if(c !== captchaVal){ $('regMsg').innerText = 'Captcha sai'; generateCaptcha(); return; }
  const users = read('users') || {};
  if(users[u]){ $('regMsg').innerText = 'TÃ i khoáº£n Ä‘Ã£ tá»“n táº¡i â€” vui lÃ²ng Ä‘Äƒng nháº­p'; return; }
  const ips = await getLocalIPs();
  const ip = ips && ips.length>0 ? ips[0] : 'unknown';
  users[u] = { password: p, balance: 0, purchases: [], regTime: Date.now(), regIp: ip };
  write('users', users);
  $('regMsg').innerText = 'ÄÄƒng kÃ½ thÃ nh cÃ´ng. Má»i Ä‘Äƒng nháº­p.';
  $('regUser').value=''; $('regPass').value=''; $('captchaInput').value='';
  setTimeout(()=> showPage('login'), 900);
});

// login
$('btnLogin').addEventListener('click', ()=>{
  const u = $('loginUser').value.trim();
  const p = $('loginPass').value;
  const users = read('users') || {};
  if(u === ADMIN_USER && p === ADMIN_PASS){
    if(!users[u]) { users[u] = { password: p, balance: 0, purchases: [], regTime: Date.now(), regIp: 'local' }; write('users', users); }
    setSession(u); $('loginMsg').innerText=''; showPage('products'); return;
  }
  if(users[u] && users[u].password === p){
    setSession(u); $('loginMsg').innerText=''; showPage('products'); return;
  }
  $('loginMsg').innerText = 'Sai tÃªn Ä‘Äƒng nháº­p hoáº·c máº­t kháº©u';
});

// logout
$('menuLogout').addEventListener('click', ()=> {
  if(confirm('Báº¡n cÃ³ muá»‘n Ä‘Äƒng xuáº¥t?')) setSession(null);
});

// render products (no view button)
function renderProducts(){
  const ps = read('products') || [];
  const container = $('productList'); container.innerHTML = '';
  if(ps.length===0){ container.innerHTML = '<div class="muted">ChÆ°a cÃ³ sáº£n pháº©m</div>'; return; }
  ps.forEach((p,i)=>{
    const d = document.createElement('div'); d.className='item';
    d.innerHTML = `<div class="title">${escapeHtml(p.name)}</div>
      <div class="small muted">${money(p.price)}</div>
      <div style="margin-top:8px"><button class="primary" onclick="buyProduct(${i})">Mua</button></div>`;
    container.appendChild(d);
  });
}
function buyProduct(idx){
  if(!currentUser){ alert('Vui lÃ²ng Ä‘Äƒng nháº­p Ä‘á»ƒ mua'); showPage('login'); return; }
  const ps = read('products') || []; const p = ps[idx];
  const users = read('users') || {}; const u = users[currentUser];
  if(!u){ alert('TÃ i khoáº£n khÃ´ng tá»“n táº¡i'); return; }
  if(Number(u.balance) < Number(p.price)){ alert('KhÃ´ng Ä‘á»§ tiá»n. Vui lÃ²ng náº¡p.'); return; }
  u.balance = Number(u.balance) - Number(p.price);
  u.purchases = u.purchases || []; u.purchases.push({ type:'product', name:p.name, link:p.link, time:Date.now() });
  users[currentUser] = u; write('users', users);
  refreshBalances();
  alert('Mua thÃ nh cÃ´ng â€” má»Ÿ link sáº£n pháº©m');
  window.open(p.link,'_blank');
  renderProducts();
}

// render blinds (no view button)
function renderBlinds(){
  const bs = read('blinds') || [];
  const container = $('blindList'); container.innerHTML = '';
  if(bs.length===0){ container.innerHTML = '<div class="muted">ChÆ°a cÃ³ tÃºi mÃ¹</div>'; return; }
  bs.forEach((b,i)=>{
    const d = document.createElement('div'); d.className='item';
    d.innerHTML = `<div class="title">${escapeHtml(b.name)}</div>
      <div class="small muted">GiÃ¡: ${money(b.price)}</div>
      <div style="margin-top:8px"><button class="primary" onclick="buyBlind(${i})">Mua</button></div>`;
    container.appendChild(d);
  });
}
function buyBlind(idx){
  if(!currentUser){ alert('ÄÄƒng nháº­p Ä‘á»ƒ mua'); showPage('login'); return; }
  const bs = read('blinds') || []; const b = bs[idx];
  const users = read('users') || {}; const u = users[currentUser];
  if(Number(u.balance) < Number(b.price)){ alert('KhÃ´ng Ä‘á»§ tiá»n'); return; }
  u.balance = Number(u.balance) - Number(b.price);
  u.purchases = u.purchases || [];
  const reward = (b.acc||b.pass) ? { acc:b.acc, pass:b.pass } : { note:'Pháº§n thÆ°á»Ÿng ngáº«u nhiÃªn' };
  u.purchases.push({ type:'blind', name:b.name, reward, time:Date.now() });
  users[currentUser] = u; write('users', users);
  refreshBalances();
  alert('Mua tÃºi mÃ¹ thÃ nh cÃ´ng â€” kiá»ƒm tra lá»‹ch sá»­ mua');
  renderBlinds();
}

// deposit / topup
function updateDepositUI(){
  const memo = currentUser ? `dh_${currentUser}` : 'dh_username';
  $('depositMemo').innerText = memo;
  $('depositQR').src = `https://img.vietqr.io/image/MBBank-381112-compact.png?amount=0&addInfo=${encodeURIComponent(memo)}&accountName=${encodeURIComponent('DAO DUC HAI')}`;
  renderTopupHistory();
}
$('btnCopyMemo').addEventListener('click', ()=> {
  navigator.clipboard?.writeText($('depositMemo').innerText).then(()=> alert('ÄÃ£ copy ná»™i dung náº¡p'));
});
$('btnPaid').addEventListener('click', ()=>{
  if(!currentUser){ alert('ÄÄƒng nháº­p Ä‘á»ƒ gá»­i yÃªu cáº§u náº¡p'); showPage('login'); return; }
  const amt = Number($('depositAmount').value || 0);
  if(!amt || amt <= 0){ $('depositStatus').innerText = 'Nháº­p sá»‘ tiá»n há»£p lá»‡'; return; }
  const reqs = read('topupRequests') || [];
  reqs.push({ id: uid(), user: currentUser, amount: amt, time: Date.now(), status: 'pending' });
  write('topupRequests', reqs);
  $('depositStatus').innerText = 'ÄÃ£ gá»­i yÃªu cáº§u náº¡p. Chá» admin duyá»‡t.';
  $('depositAmount').value = '';
  renderTopupHistory();
  renderAdminTopups();
});

// user topup history
function renderTopupHistory(){
  if(!currentUser){ $('topupHistory').innerHTML = '<div class="muted">ÄÄƒng nháº­p Ä‘á»ƒ xem lá»‹ch sá»­</div>'; return; }
  const reqs = (read('topupRequests')||[]).filter(r=> r.user === currentUser).slice().reverse();
  if(reqs.length===0){ $('topupHistory').innerHTML = '<div class="muted">ChÆ°a cÃ³ yÃªu cáº§u</div>'; return; }
  let html=''; reqs.forEach(r => html += `<div class="item">${new Date(r.time).toLocaleString()} â€” ${money(r.amount)} â€” ${r.status}</div>`);
  $('topupHistory').innerHTML = html;
}

// admin area
function renderAdminAll(){ renderProductsAdmin(); renderBlindsAdmin(); renderUsersAdmin(); renderAdminTopups(); }
function renderProductsAdmin(){
  const ps = read('products')||[]; let html='';
  ps.forEach((p,i)=> html += `<div class="item">${escapeHtml(p.name)} â€” ${money(p.price)} â€” <a href="${encodeURI(p.link)}" target="_blank" style="color:var(--gold)">Link</a> <span style="float:right"><button class="ghost" onclick="adminEditProduct(${i})">Sá»­a</button> <button class="ghost" onclick="adminDeleteProduct(${i})">XÃ³a</button></span></div>`);
  $('adminProducts').innerHTML = html || '<div class="muted">ChÆ°a cÃ³ sáº£n pháº©m</div>';
}
function adminAddProduct(){
  const n = $('admin_p_name').value.trim(); const pr = Number($('admin_p_price').value||0); const link = $('admin_p_link').value.trim();
  if(!n || !pr || !link){ alert('Nháº­p tÃªn, giÃ¡ vÃ  link'); return; }
  const ps = read('products')||[]; ps.push({name:n, price:pr, link}); write('products', ps);
  $('admin_p_name').value=''; $('admin_p_price').value=''; $('admin_p_link').value='';
  renderProducts(); renderProductsAdmin();
}
function adminEditProduct(i){ const ps = read('products')||[]; const p = ps[i]; $('admin_p_name').value=p.name; $('admin_p_price').value=p.price; $('admin_p_link').value=p.link; ps.splice(i,1); write('products', ps); renderProductsAdmin(); renderProducts(); }
function adminDeleteProduct(i){ if(!confirm('XÃ³a sáº£n pháº©m?')) return; const ps = read('products')||[]; ps.splice(i,1); write('products', ps); renderProductsAdmin(); renderProducts(); }
$('adminAddProd').addEventListener('click', adminAddProduct);
$('adminClearProd').addEventListener('click', ()=>{ $('admin_p_name').value=''; $('admin_p_price').value=''; $('admin_p_link').value=''; });

function renderBlindsAdmin(){
  const bs = read('blinds')||[]; let html='';
  bs.forEach((b,i)=> html += `<div class="item">${escapeHtml(b.name)} â€” ${money(b.price)} â€” TK: ${escapeHtml(b.acc||'(n/a)')} / MK: ${escapeHtml(b.pass||'(n/a)')} <span style="float:right"><button class="ghost" onclick="adminEditBlind(${i})">Sá»­a</button> <button class="ghost" onclick="adminDeleteBlind(${i})">XÃ³a</button></span></div>`);
  $('adminBlinds').innerHTML = html || '<div class="muted">ChÆ°a cÃ³ tÃºi mÃ¹</div>';
}
function adminAddBlind(){ const n=$('admin_b_name').value.trim(); const pr=Number($('admin_b_price').value||0); const acc=$('admin_b_acc').value.trim(); const pass=$('admin_b_pass').value.trim(); if(!n||!pr){ alert('Nháº­p tÃªn vÃ  giÃ¡'); return; } const bs = read('blinds')||[]; bs.push({name:n, price:pr, acc, pass}); write('blinds', bs); $('admin_b_name').value=''; $('admin_b_price').value=''; $('admin_b_acc').value=''; $('admin_b_pass').value=''; renderBlinds(); renderBlindsAdmin(); }
function adminEditBlind(i){ const bs = read('blinds')||[]; const b = bs[i]; $('admin_b_name').value=b.name; $('admin_b_price').value=b.price; $('admin_b_acc').value=b.acc; $('admin_b_pass').value=b.pass; bs.splice(i,1); write('blinds', bs); renderBlindsAdmin(); }
function adminDeleteBlind(i){ if(!confirm('XÃ³a tÃºi mÃ¹?')) return; const bs = read('blinds')||[]; bs.splice(i,1); write('blinds', bs); renderBlindsAdmin(); renderBlinds(); }
$('adminAddBlind').addEventListener('click', adminAddBlind);
$('adminClearBlind').addEventListener('click', ()=>{ $('admin_b_name').value=''; $('admin_b_price').value=''; $('admin_b_acc').value=''; $('admin_b_pass').value=''; });

function renderUsersAdmin(){
  const users = read('users')||{}; let html='';
  Object.keys(users).forEach(u => {
    const info = users[u];
    html += `<div class="item"><b>${escapeHtml(u)}</b> â€” ${money(info.balance||0)} <div class="muted small">ÄK: ${info.regTime ? new Date(info.regTime).toLocaleString() : '-'} â€” IP: ${info.regIp || '-'}</div><div style="margin-top:8px"><button class="ghost" onclick="adminCreditPrompt('${u}')">Cá»™ng tiá»n</button> <button class="ghost" onclick="adminDeleteUser('${u}')">XÃ³a</button></div></div>`;
  });
  $('adminUsers').innerHTML = html || '<div class="muted">KhÃ´ng cÃ³ user</div>';
}
function adminCreditPrompt(u){ const v = Number(prompt('Nháº­p sá»‘ tiá»n cá»™ng cho ' + u,'10000')||0); if(!v) return; adminAddCredit(u,v); }
function adminAddCredit(u,amt){ const users = read('users')||{}; if(!users[u]) users[u] = { password:'', balance:0, purchases:[] }; users[u].balance = Number(users[u].balance||0) + Number(amt); write('users', users); renderUsersAdmin(); refreshBalances(); alert('ÄÃ£ cá»™ng ' + money(amt) + ' cho ' + u); }
function adminDeleteUser(u){ if(!confirm('XÃ³a tÃ i khoáº£n '+u+' ?')) return; const users=read('users')||{}; delete users[u]; write('users', users); renderUsersAdmin(); alert('ÄÃ£ xÃ³a '+u); }

function renderAdminTopups(){
  const reqs = read('topupRequests')||[]; if(reqs.length===0){ $('adminTopups').innerHTML = '<div class="muted">KhÃ´ng cÃ³ yÃªu cáº§u</div>'; return; }
  let html=''; reqs.forEach(r => { html += `<div class="item"><b>${escapeHtml(r.user)}</b> â€” ${money(r.amount)} <div class="muted small">${new Date(r.time).toLocaleString()} â€” ${r.status}</div><div style="margin-top:8px">${r.status==='pending' ? `<button class="primary" onclick="adminApproveTopup('${r.id}')">Duyá»‡t</button> <button class="ghost" onclick="adminRejectTopup('${r.id}')">Tá»« chá»‘i</button>` : ''}</div></div>`; }); $('adminTopups').innerHTML = html; }
function adminApproveTopup(id){ const reqs = read('topupRequests')||[]; const r = reqs.find(x=>x.id===id); if(!r) return; if(r.status!=='pending'){ alert('ÄÃ£ xá»­ lÃ½'); return; } const users = read('users')||{}; if(!users[r.user]) users[r.user] = { password:'', balance:0, purchases:[] }; users[r.user].balance = Number(users[r.user].balance||0) + Number(r.amount); write('users', users); r.status='approved'; write('topupRequests', reqs); renderAdminTopups(); renderUsersAdmin(); refreshBalances(); alert('ÄÃ£ duyá»‡t & cá»™ng tiá»n cho ' + r.user); }
function adminRejectTopup(id){ const reqs = read('topupRequests')||[]; const r = reqs.find(x=>x.id===id); if(!r) return; r.status='rejected'; write('topupRequests', reqs); renderAdminTopups(); alert('ÄÃ£ tá»« chá»‘i'); }

// refresh & helpers
function refreshAll(){ renderProducts(); renderBlinds(); renderAdminAll(); renderUsersAdmin(); renderAdminTopups(); refreshBalances(); renderTopupHistory(); }
function refreshBalances(){ const users = read('users')||{}; if(currentUser && users[currentUser]){ $('uiBalance').innerText = money(users[currentUser].balance); $('uiBalance2').innerText = money(users[currentUser].balance); } else { $('uiBalance').innerText = money(0); $('uiBalance2').innerText = money(0); } }
function renderTopupHistory(){ if(!currentUser){ $('topupHistory').innerHTML = '<div class="muted">ÄÄƒng nháº­p Ä‘á»ƒ xem lá»‹ch sá»­</div>'; return; } const reqs = (read('topupRequests')||[]).filter(r=> r.user===currentUser).slice().reverse(); if(reqs.length===0){ $('topupHistory').innerHTML = '<div class="muted">ChÆ°a cÃ³ yÃªu cáº§u</div>'; return; } let html=''; reqs.forEach(r=> html += `<div class="item">${new Date(r.time).toLocaleString()} â€” ${money(r.amount)} â€” ${r.status}</div>`); $('topupHistory').innerHTML = html; }

// expose functions for onclick in template
window.buyProduct = buyProduct;
window.buyBlind = buyBlind;
window.adminEditProduct = adminEditProduct;
window.adminDeleteProduct = adminDeleteProduct;
window.adminEditBlind = adminEditBlind;
window.adminDeleteBlind = adminDeleteBlind;
window.adminApproveTopup = adminApproveTopup;
window.adminRejectTopup = adminRejectTopup;
window.adminAddCredit = adminAddCredit;
window.adminDeleteUser = adminDeleteUser;

// wiring
$('adminAddProd').addEventListener('click', adminAddProduct);
$('adminAddBlind').addEventListener('click', adminAddBlind);
$('menuLogout').addEventListener('click', ()=> { if(confirm('ÄÄƒng xuáº¥t?')) setSession(null); });

// init
if(currentUser){ updateAuthUI(); showPage('products'); } else { updateAuthUI(); showPage('home'); }
generateCaptcha();
refreshAll();

</script>
</body>
</html>